<div class="row">
    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
        <h3>Results</h3>
    </div>
</div>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <p>
            <button class="btn btn-outline" (click)="openResultsQueryWizard()">
                <clr-icon shape="search"></clr-icon> Open Results Query Builder
            </button>

    </div>
</div>

<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

        <clr-wizard #resultsQueryWizard [(clrWizardOpen)]="resultsQueryWizardActive">
            <clr-wizard-title>Results Query Builder</clr-wizard-title>

            <clr-wizard-button [type]="'cancel'">Cancel</clr-wizard-button>
            <clr-wizard-button [type]="'previous'">Back</clr-wizard-button>
            <clr-wizard-button [type]="'next'">Next</clr-wizard-button>
            <clr-wizard-button [type]="'finish'">Finish</clr-wizard-button>

            <clr-wizard-page (clrWizardPageCustomButton)="doCustomClick($event)">
                <ng-template clrPageTitle>Select Samples</ng-template>

                <!-- Begin sample query form -->
                <div class="card-text">
                    <form class="form compact" [formGroup]="sampleQueryForm"
                        (ngSubmit)="onSubmitSampleQuery(sampleQueryForm.value)">
                        <section class="form-block">

                            <div class="form-group">
                                <label [ngClass]="{'required': sampleQueryForm.get('study').enabled}">Study</label>
                                <label for="studySelect" aria-haspopup="true" role="tooltip"
                                    class="tooltip tooltip-validation tooltip-sm"
                                    [class.invalid]="sampleQueryForm.get('study').invalid && (sampleQueryForm.get('study').dirty || sampleQueryForm.get('study').touched)">
                                    <div class="select">
                                        <select id="studySelect" name="study" formControlName="study">
                                            <option value="">
                                                <span class="all">ALL STUDIES</span>
                                            </option>
                                            <option *ngFor="let study of studies" [value]="study.id">{{study.name}}
                                            </option>
                                        </select>
                                    </div>
                                </label>
                            </div>

                            <div class="form-group">
                                <label>Sample ID Range</label>
                                <span>From</span>
                                <input type="number" formControlName="from_id">
                                <span>To</span>
                                <input type="number" formControlName="to_id">
                            </div>

                            <div class="form-group">
                                <label>Collection Start Date Range</label>
                                <span>From</span>
                                <input type="date" formControlName="from_collection_start_date">
                                <span>To</span>
                                <input type="date" formControlName="to_collection_start_date">
                            </div>

                            <div class="form-group">
                                <label>Collaborator Sample ID</label>
                                <input id="collabSampleIdInput" type="text" formControlName="collaborator_sample_id">
                            </div>

                            <!-- <div class="form-group">
                                <label>Matrix</label>
                                <div class="select">
                                    <select id="matrixSelect" name="matrix" formControlName="matrix">
                                        <option value="">
                                            <span class="all">ALL MATRICES</span>
                                        </option>
                                        <option *ngFor="let matrix of matrices" [value]="matrix.id">{{matrix.name}}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Sample type</label>
                                <div class="select">
                                    <select id="sampleTypeSelect" name="sample_type" formControlName="sample_type">
                                        <option value="">
                                            <span class="all">ALL SAMPLE TYPES</span>
                                        </option>
                                        <option *ngFor="let sampleType of sampleTypes" [value]="sampleType.id">{{sampleType.name}}</option>
                                    </select>
                                </div>
                            </div> -->

                        </section>

                        <clr-alert [clrAlertType]="'alert-danger'" *ngIf="sampleQuerySizeErrorFlag">
                            <div class="alert-item">
                                <span class="alert-text">Your query results are too large (greater than
                                    {{queryCountLimit}}). Please narrow your search.</span>
                            </div>
                        </clr-alert>

                        <button class="btn btn-primary" type="submit" [clrLoading]="submitLoading">
                            <clr-icon shape="filter"></clr-icon> Filter Samples
                        </button>
                    </form>
                </div>

                <div *ngIf="sampleQueryComplete">
                    <h4>Query returned {{samplesCount}} sample records</h4>
                </div>
                <!-- End sample query form -->


                <div class="in-wizard-datagrid">
                    <clr-datagrid [(clrDgSelected)]="selected" [clrDgLoading]="samplesLoading" [clDgRowSelection]="true"
                        class="datagrid-compact">

                        <clr-dg-action-bar>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-secondary" (click)="deselectAll()">
                                    <clr-icon shape="window-close" size="16"></clr-icon> Deselect All
                                </button>
                            </div>
                        </clr-dg-action-bar>

                        <clr-dg-column [clrDgField]="'id'">
                            Sample ID
                            <clr-dg-filter [clrDgFilter]="rangeFilter">
                                <range-filter #rangeFilter></range-filter>
                            </clr-dg-filter>
                        </clr-dg-column>

                        <clr-dg-column [clrDgField]="'collaborator_sample_id'">
                            <ng-container *clrDgHideableColumn="{hidden: false}">
                                Collaborator Sample ID
                            </ng-container>
                        </clr-dg-column>

                        <clr-dg-column [clrDgField]="'study_string'">
                            Study
                            <clr-dg-filter [clrDgFilter]="studyFilter">
                                <study-filter #studyFilter></study-filter>
                            </clr-dg-filter>
                        </clr-dg-column>


                        <clr-dg-column [clrDgField]="'collection_start_date'">
                            Collect Start Date
                            <clr-dg-filter [clrDgFilter]="CollectionStartDateFilter">
                                <collection-start-date-filter [dateField]="'collection_start_date'"
                                    #CollectionStartDateFilter></collection-start-date-filter>
                            </clr-dg-filter>
                        </clr-dg-column>

                        <clr-dg-row *clrDgItems="let sample of allSamples" [clrDgItem]="sample">
                            <clr-dg-cell>{{sample.id}}</clr-dg-cell>
                            <clr-dg-cell>{{sample.collaborator_sample_id}}</clr-dg-cell>
                            <clr-dg-cell>{{sample.study_string}}</clr-dg-cell>
                            <clr-dg-cell>{{sample.collection_start_date | date:'shortDate'}}</clr-dg-cell>
                        </clr-dg-row>

                        <clr-dg-footer>
                            {{pagination.firstItem + 1}} - {{pagination.lastItem + 1}} of {{pagination.totalItems}}
                            samples
                            <clr-dg-pagination #pagination [clrDgPageSize]="10"></clr-dg-pagination>
                        </clr-dg-footer>
                    </clr-datagrid>

                </div>
                <p>
                    <clr-alert [clrAlertType]="'alert-danger'" *ngIf="sampleSelectErrorFlag">
                        <div clr-alert-item class="alert-item">
                            <span class="alert-text">Please select at least one sample to continue.</span>
                        </div>
                    </clr-alert>

                    <ng-template clrPageButtons>
                        <clr-wizard-button [type]="'custom-cancel'">Cancel</clr-wizard-button>
                        <clr-wizard-button [type]="'custom-previous'">Back</clr-wizard-button>
                        <clr-wizard-button [type]="'custom-next-sampleSelect'">Next</clr-wizard-button>
                    </ng-template>
            </clr-wizard-page>

            <clr-wizard-page (clrWizardPageCustomButton)="doCustomClick($event)">
                <ng-template clrPageTitle>Select Targets</ng-template>
                <div class="in-wizard-datagrid">
                    <clr-datagrid [(clrDgSelected)]="selected" [clDgRowSelection]="true" class="datagrid-compact">

                        <clr-dg-column [clrDgField]="'name'">Name</clr-dg-column>
                        <clr-dg-column [clrDgField]="'code'">Code</clr-dg-column>
                        <clr-dg-column [clrDgField]="'type'">Type</clr-dg-column>

                        <clr-dg-row *clrDgItems="let target of allTargets" [clrDgItem]="target">
                            <clr-dg-cell>{{target.name}}</clr-dg-cell>
                            <clr-dg-cell>{{target.code}}</clr-dg-cell>
                            <clr-dg-cell>{{target.nucleic_acid_type | displayValue:'name':this.nucleicAcidTypes }}
                            </clr-dg-cell>
                        </clr-dg-row>

                        <clr-dg-footer>{{allTargets.length}} targets</clr-dg-footer>
                    </clr-datagrid>
                </div>
                <clr-alert [clrAlertType]="'alert-danger'" *ngIf="targetSelectErrorFlag">
                    <div clr-alert-item class="alert-item">
                        <span class="alert-text">Please select at least one target to continue.</span>
                    </div>
                </clr-alert>
                <ng-template clrPageButtons>
                    <clr-wizard-button [type]="'custom-cancel'">Cancel</clr-wizard-button>
                    <clr-wizard-button [type]="'custom-previous'">Back</clr-wizard-button>
                    <clr-wizard-button [type]="'custom-next-targetSelect'">Next</clr-wizard-button>
                </ng-template>
            </clr-wizard-page>

            <clr-wizard-page (clrWizardPageCustomButton)="doCustomClick($event)">
                <ng-template clrPageTitle>Query Summary</ng-template>
                <label>Samples:</label>
                <ul class="list">
                    <li *ngFor="let sample of resultsQuery.samples">{{sample}}</li>
                </ul>
                <p>
                    <label>Targets:</label>
                    <ul class="list">
                        <li *ngFor="let target of resultsQuery.targets">{{target | displayValue:'name': allTargets}}
                        </li>
                    </ul>

                    <ng-template clrPageButtons>
                        <clr-wizard-button [type]="'cancel'">Cancel</clr-wizard-button>
                        <clr-wizard-button [type]="'custom-previous'">Back</clr-wizard-button>
                        <clr-wizard-button [type]="'custom-finish'">Finish</clr-wizard-button>
                    </ng-template>

            </clr-wizard-page>
        </clr-wizard>

    </div>
</div>

<div class="row">
    <div class="col-lg-8 col-sm-12">

        <span><label>Note: Sample Mean Concentration may not not yet be calculated if sample/target combination is
                missing
                valid controls or all replicates. Click 'Details' to view full business rules and replicate details
                explanations.</label>
            <button class="btn btn-outline btn-sm" (click)="showBusinessRulesModal = true">Details</button></span>
    </div>
</div>

<div class="row">
    <!---------- Loading spinner---------->
    <span class="spinner spinner-lg" *ngIf="resultsLoading">
        Loading...
    </span>
    <!---------- Loading spinner---------->
</div>

<div class="row">

    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" *ngIf="resultsLoaded && results.length === 0">
        There are no results for your query.
    </div>

    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" *ngIf="resultsLoaded && results.length > 0">
        <clr-datagrid [clrDgLoading]="resultsLoading">

            <clr-dg-action-bar>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-secondary" (click)="exportToCSV()">
                        <clr-icon shape="export" size="16"></clr-icon> Export to CSV
                    </button>
                </div>
            </clr-dg-action-bar>

            <clr-dg-column [clrDgField]="'sample'">
                Sample ID
                <clr-dg-filter [clrDgFilter]="rangeFilter">
                    <range-filter #rangeFilter></range-filter>
                </clr-dg-filter>
            </clr-dg-column>

            <clr-dg-column [clrDgField]="'collaborator_sample_id'">
                <ng-container *clrDgHideableColumn="{hidden: false}">
                    Collaborator Sample ID
                </ng-container>
            </clr-dg-column>

            <clr-dg-column [clrDgField]="'collection_start_date'">
                Collect Start Date
                <clr-dg-filter [clrDgFilter]="CollectionStartDateFilter">
                    <collection-start-date-filter [dateField]="'collection_start_date'" #CollectionStartDateFilter>
                    </collection-start-date-filter>
                </clr-dg-filter>
            </clr-dg-column>

            <clr-dg-column [clrDgField]="'target'">
                Target
                <clr-dg-filter [clrDgFilter]="targetFilter">
                    <target-filter #targetFilter></target-filter>
                </clr-dg-filter>
            </clr-dg-column>

            <clr-dg-column [clrDgField]="'sample_mean_concentration'">
                <ng-container *clrDgHideableColumn="{hidden: false}">
                    Sample Mean Concentration
                </ng-container>
            </clr-dg-column>

            <clr-dg-column>
                <ng-container *clrDgHideableColumn="{hidden: false}">
                    Complete Replicates
                </ng-container>
            </clr-dg-column>

            <clr-dg-column>
                <ng-container *clrDgHideableColumn="{hidden: false}">
                    Incomplete Replicates
                </ng-container>
            </clr-dg-column>

            <clr-dg-row *clrDgItems="let fsmc of results" [clrDgItem]="fsmc">
                <clr-dg-cell>{{fsmc.sample}}</clr-dg-cell>
                <clr-dg-cell>{{fsmc.collaborator_sample_id}}</clr-dg-cell>
                <clr-dg-cell>{{fsmc.collection_start_date | date:'shortDate'}}</clr-dg-cell>
                <clr-dg-cell>{{fsmc.target | displayValue:'name': allTargets }}</clr-dg-cell>
                <!-- <clr-dg-cell>{{fsmc.final_sample_mean_concentration_sci}}</clr-dg-cell> -->
                <clr-dg-cell>
                    {{fsmc.final_sample_mean_concentration_sci === "" ? "No Result" : fsmc.final_sample_mean_concentration_sci}}
                </clr-dg-cell>
                <clr-dg-cell>
                    <a class="label label-blue clickable"
                        *ngIf="fsmc.sample_target_replicates.positive_concentration_count > 0"
                        (click)="openReplicateDetails('positive_concentrations', fsmc)">Positive
                        Concentrations&nbsp;<span
                            class="badge">{{fsmc.sample_target_replicates.positive_concentration_count}}</span></a>
                    <br>
                    <a class="label label-blue clickable"
                        *ngIf="fsmc.sample_target_replicates.negative_concentration_count > 0"
                        (click)="openReplicateDetails('negative_concentrations', fsmc)">Negative
                        Concentrations&nbsp;<span
                            class="badge">{{fsmc.sample_target_replicates.negative_concentration_count}}</span></a>
                </clr-dg-cell>
                <clr-dg-cell>
                    <a class="label label-blue clickable"
                        *ngIf="fsmc.sample_target_replicates.qpcr_results_missing_count > 0"
                        (click)="openReplicateDetails('qpcr_results_missing', fsmc)">Missing qPCR Values&nbsp;<span
                            class="badge">{{fsmc.sample_target_replicates.qpcr_results_missing_count}}</span></a>
                    <br>
                    <a class="label label-blue clickable"
                        *ngIf="fsmc.sample_target_replicates.concentration_calc_values_missing_count > 0"
                        (click)="openReplicateDetails('concentration_calc_values_missing', fsmc)">Calculation Values
                        Missing&nbsp;<span
                            class="badge">{{fsmc.sample_target_replicates.concentration_calc_values_missing_count}}</span></a>
                    <br>
                    <a class="label label-blue clickable" *ngIf="fsmc.sample_target_replicates.invalid_count > 0"
                        (click)="openReplicateDetails('invalids', fsmc)">Invalid per controls&nbsp;<span
                            class="badge">{{fsmc.sample_target_replicates.invalid_count}}</span></a>
                </clr-dg-cell>
            </clr-dg-row>

            <clr-dg-footer>
                {{pagination.firstItem + 1}} - {{pagination.lastItem + 1}} of {{pagination.totalItems}} results
                <clr-dg-pagination #pagination [clrDgPageSize]="10"></clr-dg-pagination>
            </clr-dg-footer>
        </clr-datagrid>


    </div>
</div>

<!-- business rules Modal -->
<clr-modal [(clrModalOpen)]="showBusinessRulesModal" [clrModalSize]="'xl'">
    <h3 class="modal-title">
        <span>Business Rules & Replicate Details Explanation</span>
    </h3>
    <div class="modal-body">
        <div class="row">
            <div class="col-sm-12">
                <div>
                    <h4>Business Rules</h4>
                    All replicate records are considered invalid by default. They are only made valid if all
                    of the
                    following checks pass:
                    <p>1.All the parent controls (Peg Neg, Ext Neg, RT Neg, PCR Neg) for this replicate have
                        been
                        entered
                        into the database
                        <p>2. The replicate’s related Peg Neg’s replicates with same target as this data
                            replicate are
                            all
                            valid (if no related Peg Neg, this check does not apply), if even a single one
                            of the Peg
                            Neg
                            replicates is invalid then the data replicate is set to invalid.
                            <p>3. The replicate's parent replicate batch negative controls (Ext Neg, RT Neg,
                                PCR Neg)
                                are all
                                valid, if even a single one of the controls is invalid then the data
                                replicate is set to
                                invalid.
                                <p>4. The replicate’s CQ value and GC/reaction are greater than or equal to
                                    zero.
                                    <p>Alternately, the user has the option to manually override the
                                        system-determined
                                        validity.
                                        <hr>
                                        <h4>Replicate details explanation</h4>
                                        <h5>Complete Replicates</h5>
                                        <span class="label label-blue">Positive concentrations</span> replicates
                                        that are fully complete with all
                                        necessary values - concentration has been calculated and is a
                                        positive number indicating presence of target.<br>
                                        <span class="label label-blue">Negative concentrations</span> replicates
                                        that are fully complete with all
                                        necessary values - concentration has been calculated and is 0,
                                        indicating absence of target.

                                        <h5>Incomplete Replicates</h5>
                                        <span class="label label-blue">Missing qPCR Values</span> replicates
                                        with Cq value and/or GC/Reaction
                                        missing, which most likely means the qPCR results text file
                                        containing that replicate was not uploaded.<br>
                                        <span class="label label-blue">Calculation Values
                                            Missing</span>replicates where concentration is not
                                        calculated because of one of the critical concentration calculation
                                        values are missing.<br>
                                        <span class="label label-blue">Invalid per controls</span> replicates
                                        that are invalid because associated
                                        controls are invalid/noncompliant.<br>

                                        <button class="btn btn-info"
                                            (click)="showBusinessRulesModal = !showBusinessRulesModal">Close</button>
                </div>
            </div>
        </div>
    </div>
</clr-modal>

<!-- replicate details Modal -->
<clr-modal [(clrModalOpen)]="showReplicateDetailsModal">
    <h3 class="modal-title">
        <span>{{replicateCategoryString}}</span>
    </h3>
    <div class="modal-body">
        <div class="row">
            <div class="col-lg-12">
                <div>
                    <clr-tree-node *ngFor="let replicate of replicateDetailArray">
                        <span>AB {{replicate.analysis_batch}}, Extraction {{replicate.extraction_number}}, Replicate
                            {{replicate.replicate_number}}
                        </span>

                        <ng-template [clrIfExpanded]="false">
                            <clr-tree-node>
                                <div class="extraction-row">

                                    <div>
                                        <table class="table table-vertical table-compact ">
                                            <tbody>
                                                <tr>
                                                    <th><span class="text-bold">Replicate Concentration</span></th>
                                                    <td>{{replicate.replicate_concentration}}</td>
                                                </tr>
                                                <tr>
                                                    <th>GC/Reaction</th>
                                                    <td>{{replicate.gc_reaction}}</td>
                                                </tr>
                                                <tr>
                                                    <th>Cq value</th>
                                                    <td>{{replicate.cq_value}}</td>
                                                </tr>
                                                <tr>
                                                    <th>Volume Extracted</th>
                                                    <td>{{replicate.calculation_values.extraction_volume}} µL</td>
                                                </tr>
                                                <tr>
                                                    <th>Volume Eluted</th>
                                                    <td>{{replicate.calculation_values.elution_volume}} µL</td>
                                                </tr>
                                                <tr>
                                                    <th>Final Concentrated Sample Volume</th>
                                                    <td>{{replicate.calculation_values.final_concentrated_sample_volume}}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Inhibition Dilution Factor</th>
                                                    <td>{{replicate.calculation_values.inhibition_dilution_factor}}</td>
                                                </tr>
                                                <tr>
                                                    <th>qPCR Reaction Volume</th>
                                                    <td>{{replicate.calculation_values.qpcr_reaction_volume}} µL</td>
                                                </tr>
                                                <tr>
                                                    <th>qPCR Template Volume</th>
                                                    <td>{{replicate.calculation_values.qpcr_template_volume}} µL</td>
                                                </tr>
                                                <tr>
                                                    <th>Sample Dilution Factor</th>
                                                    <td>{{replicate.calculation_values.sample_dilution_factor}}</td>
                                                </tr>
                                                <tr>
                                                    <th>Dissolution Volume</th>
                                                    <td>{{replicate.calculation_values.dissolution_volume}}</td>
                                                </tr>
                                                <tr>
                                                    <th>Post Dilution Volume</th>
                                                    <td>{{replicate.calculation_values.post_dilution_volume}}</td>
                                                </tr>
                                                <tr>
                                                    <th>Total Volume or Mass Sampled</th>
                                                    <td>{{replicate.calculation_values.total_volume_or_mass_sampled}}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Matrix Code</th>
                                                    <td>{{replicate.calculation_values.matrix_code}}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <ul>
                                            <li *ngIf="replicate.missing_calculation_values.inhibition_dilution_factor">
                                                Missing Inhibition Dilution Factor <span>(Inhibition
                                                    {{replicate.inhibition.id}}, AB
                                                    {{replicate.inhibition.analysis_batch}}, Extraction
                                                    {{replicate.inhibition.extraction_number}}, Sample
                                                    {{replicate.inhibition.sample}}
                                                    ({{replicate.inhibition.nucleic_acid_type}})</span></li>
                                            <li
                                                *ngIf="replicate.missing_calculation_values.final_concentrated_sample_volume">
                                                Missing Final Concentrated Sample Volume</li>
                                            <li *ngIf="replicate.missing_calculation_values.sample_dissolution_volume">
                                                Missing Dissolution Volume</li>
                                            <li *ngIf="replicate.missing_calculation_values.sample_post_dilution_value">
                                                Missing Post-dilution volume
                                            </li>
                                        </ul>
                                        <hr>
                                        <ul>
                                            <li *ngIf="replicate.invalid_reasons.peg_neg_invalid">PEG NEG is invalid
                                            </li>
                                            <li *ngIf="replicate.invalid_reasons.peg_neg_missing">PEG NEG is missing
                                                <clr-tree-node><span>Missing PEG NEGs</span>
                                                    <ng-template [clrIfExpanded]="false">
                                                        <clr-tree-node>
                                                            <ul>
                                                                <li
                                                                    *ngFor="let item of replicate.invalid_reasons.peg_neg_missing_replicates">
                                                                    AB {{item.analysis_batch}}, Extraction
                                                                    {{item.extraction_number}}, Replicate
                                                                    {{item.replicate_number}}, Sample {{item.sample}},
                                                                    {{item.target | displayValue:'name': allTargets}}
                                                                </li>
                                                            </ul>
                                                        </clr-tree-node>
                                                    </ng-template>
                                                </clr-tree-node>
                                            </li>
                                            <li *ngIf="replicate.invalid_reasons.ext_neg_missing">Extraction Negative is
                                                missing</li>
                                            <li *ngIf="replicate.invalid_reasons.ext_neg_positive">Extraction Negative
                                                is invalid</li>
                                            <li *ngIf="replicate.invalid_reasons.rt_neg_missing">RT Negative is missing
                                            </li>
                                            <li *ngIf="replicate.invalid_reasons.rt_neg_positive">RT Negative is invalid
                                            </li>
                                            <li *ngIf="replicate.invalid_reasons.pcr_neg_missing">PCR Negative is
                                                missing</li>
                                            <li *ngIf="replicate.invalid_reasons.pcr_neg_positive">PCR Negative is
                                                invalid</li>
                                        </ul>

                                    </div>
                                </div>
                            </clr-tree-node>
                        </ng-template>
                    </clr-tree-node>

                    <button class="btn btn-info"
                        (click)="showReplicateDetailsModal = !showReplicateDetailsModal">Close</button>
                </div>
            </div>
        </div>
    </div>
</clr-modal>